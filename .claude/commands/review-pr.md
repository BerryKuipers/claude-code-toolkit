# Review PR - Comprehensive Pull Request Code Review

**Arguments:** [PR_NUMBER] [--focus=AREA] [--post-to-pr]

**Success Criteria:** Code review completed successfully with findings reported to user and optionally posted to PR

**Description:** User-facing command to trigger comprehensive code review by the code-reviewer agent

---

## Purpose

Provides a clean interface for users to request comprehensive code reviews of pull requests. This command validates the PR exists, gathers context, delegates to the specialized code-reviewer agent, and presents findings in an actionable format.

---

## Important: Tool Scope

**This command is a user interface tool that delegates to a specialist agent:**
- Validates PR existence and gathers metadata
- Delegates analysis to code-reviewer agent (does NOT perform review itself)
- Formats and presents review findings
- Optionally posts review comments to the PR
- Does NOT modify code (analysis only)
- Does NOT handle full PR lifecycle (see `/pr-process` for that)

---

## Workflow

### **Step 1: Parse and Validate Arguments**

```bash
# Extract PR number (required)
PR_NUMBER="${1:?Error: PR_NUMBER is required. Usage: /review-pr PR_NUMBER [--focus=AREA] [--post-to-pr]}"

# Parse optional flags
FOCUS_AREA=""
POST_TO_PR=false

for arg in "$@"; do
  case "$arg" in
    --focus=*)
      FOCUS_AREA="${arg#*=}"
      echo "Focus area: $FOCUS_AREA"
      ;;
    --post-to-pr)
      POST_TO_PR=true
      echo "Will post review to PR after completion"
      ;;
  esac
done
```

**Success Criteria:** Arguments parsed correctly, PR number extracted

---

### **Step 2: Validate PR Exists**

```bash
echo "Validating PR #${PR_NUMBER}..."

# Check if PR exists and get metadata
PR_DATA=$(gh pr view "$PR_NUMBER" --json number,title,headRefName,state,url,author 2>&1)

if [[ $? -ne 0 ]]; then
  echo "Error: PR #${PR_NUMBER} not found or inaccessible"
  echo "$PR_DATA"
  exit 1
fi

# Extract PR details
PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
PR_URL=$(echo "$PR_DATA" | jq -r '.url')
PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')

echo "Found PR #${PR_NUMBER}: $PR_TITLE"
echo "Branch: $PR_BRANCH"
echo "State: $PR_STATE"
echo "Author: $PR_AUTHOR"
echo "URL: $PR_URL"
echo ""

# Warn if PR is not open
if [[ "$PR_STATE" != "OPEN" ]]; then
  echo "Warning: PR is $PR_STATE (not OPEN)"
  echo "Continue anyway? [y/N]"
  # In automated mode, we continue regardless
fi
```

**Success Criteria:** PR exists, metadata retrieved successfully

---

### **Step 3: Delegate to Code Reviewer Agent**

**Natural Language Delegation:**

I need the code-reviewer specialist to conduct a comprehensive review of this pull request.

**Review Context:**
- PR Number: #${PR_NUMBER}
- Title: ${PR_TITLE}
- Branch: ${PR_BRANCH}
- Author: ${PR_AUTHOR}
- URL: ${PR_URL}
${FOCUS_AREA:+- Focus Area: ${FOCUS_AREA}}

**Review Scope:**
The code-reviewer agent should analyze all changed files in this PR and provide:
1. Code quality assessment (readability, maintainability, standards compliance)
2. Anti-pattern and code smell detection
3. Security vulnerability identification
4. Performance issue analysis
5. Test coverage evaluation
6. Documentation completeness review
7. Best practices validation

${FOCUS_AREA:+**Special Focus**: Please pay extra attention to ${FOCUS_AREA}-related aspects of the code.}

**Output Required:**
- Structured review report with severity-rated findings
- Actionable recommendations with examples
- Summary of critical, high, medium, and low priority issues
- Overall assessment and approval recommendation

**Success Criteria:** Code-reviewer agent completes analysis and returns structured findings

---

### **Step 4: Display Review Summary to User**

```bash
echo "=========================================="
echo "Code Review Summary - PR #${PR_NUMBER}"
echo "=========================================="
echo ""
echo "Title: $PR_TITLE"
echo "Branch: $PR_BRANCH"
echo "Reviewer: Code Reviewer Agent"
echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo ""

# The code-reviewer agent will have generated a detailed report
# Display the key sections to the user

echo "Review report generated by code-reviewer agent displayed above."
echo ""

# Count findings by severity (if available in agent output)
echo "Findings Summary:"
echo "- Critical: [agent provides count]"
echo "- High: [agent provides count]"
echo "- Medium: [agent provides count]"
echo "- Low/Info: [agent provides count]"
echo ""

echo "See detailed findings above for specifics."
```

**Success Criteria:** Review summary clearly presented to user with severity breakdown

---

### **Step 5: Optionally Post Review to PR**

```bash
if [[ "$POST_TO_PR" == "true" ]]; then
  echo "Posting review to PR #${PR_NUMBER}..."

  # Create a formatted review comment from agent output
  # The code-reviewer agent should provide markdown-formatted output

  REVIEW_BODY="$(cat <<'EOF'
## Automated Code Review - Code Reviewer Agent

**Review Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
${FOCUS_AREA:+**Focus Area:** ${FOCUS_AREA}}

### Summary

[Agent provides summary here]

### Findings

[Agent provides detailed findings here]

### Recommendations

[Agent provides recommendations here]

---
Generated with Claude Code - Code Reviewer Agent
EOF
)"

  # Post as PR comment
  gh pr comment "$PR_NUMBER" --body "$REVIEW_BODY"

  if [[ $? -eq 0 ]]; then
    echo "Review posted to PR #${PR_NUMBER}"
    echo "View at: ${PR_URL}#discussion"
  else
    echo "Warning: Failed to post review to PR"
    echo "Review content saved to: .claude/reviews/pr-${PR_NUMBER}-review.md"
    mkdir -p .claude/reviews
    echo "$REVIEW_BODY" > ".claude/reviews/pr-${PR_NUMBER}-review.md"
  fi
else
  echo "Review complete. Use --post-to-pr flag to post this review to the PR."
  echo ""
  echo "To save this review for later:"
  echo "  Run: /review-pr $PR_NUMBER --post-to-pr"
fi

echo ""
echo "Review session complete!"
```

**Success Criteria:**
- If `--post-to-pr`: Review successfully posted as PR comment
- If not: User informed how to post review manually

---

## Arguments

### `PR_NUMBER` (required)
The pull request number to review.

**Format:** Integer (e.g., `123`, `456`)

**Example:** `/review-pr 123`

### `--focus=AREA` (optional)
Specify a particular area to focus the review on.

**Valid Areas:**
- `security` - Security vulnerabilities and risks
- `performance` - Performance bottlenecks and optimization
- `testing` - Test coverage and quality
- `documentation` - Documentation completeness
- `architecture` - Architectural patterns and structure
- `style` - Code style and formatting

**Example:** `/review-pr 456 --focus=security`

### `--post-to-pr` (optional)
Automatically post the review findings as a comment on the PR.

**Behavior:**
- Without flag: Review displayed in terminal only
- With flag: Review posted as PR comment via `gh pr comment`

**Example:** `/review-pr 789 --focus=performance --post-to-pr`

---

## Usage Examples

### Basic Review

```bash
/review-pr 123
```

Reviews PR #123 and displays findings in terminal.

### Focused Security Review

```bash
/review-pr 456 --focus=security
```

Reviews PR #456 with extra attention to security issues.

### Review and Post to PR

```bash
/review-pr 789 --post-to-pr
```

Reviews PR #789 and posts findings as a PR comment.

### Comprehensive Review with All Options

```bash
/review-pr 101 --focus=architecture --post-to-pr
```

Reviews PR #101 focusing on architecture, then posts review to PR.

---

## Safety

### Read-Only Operation
- This command performs analysis only
- No code modifications are made
- PR state is not changed

### GitHub API Rate Limits
- Uses `gh` CLI which respects GitHub API rate limits
- For bulk reviews, consider spacing out requests

### Posting to PRs
- `--post-to-pr` requires write access to repository
- Review comments are public and visible to all collaborators
- Use caution when reviewing sensitive security issues (consider private communication)

### Privacy Considerations
- PR content and review findings may contain sensitive information
- Review reports are stored locally in `.claude/reviews/` if posting fails
- Clean up stored reviews periodically

---

## Success Criteria

- [x] PR exists and metadata retrieved successfully
- [x] Code-reviewer agent completes comprehensive analysis
- [x] Findings presented in clear, actionable format
- [x] Severity ratings provided for all issues
- [x] Review optionally posted to PR (if `--post-to-pr` flag used)
- [x] No errors during execution

---

## Related Commands & Agents

**Commands:**
- `/pr-process` - Complete PR lifecycle workflow (merge, test, review, CI)
- `/design-review` - Design and architecture review
- `/system-review` - System-wide code quality review

**Agents:**
- **code-reviewer** - Specialist agent that performs the actual review analysis
- **architect** - For architectural validation (use for `--focus=architecture`)
- **security-pentest** - For deep security audits (use for comprehensive security review)

---

## Notes

### Difference from `/pr-process`

**`/review-pr`** (this command):
- Focused on code review analysis only
- Does NOT modify code or merge PR
- Quick, read-only assessment
- Optionally posts review comments
- User-initiated review request

**`/pr-process`**:
- Complete PR lifecycle management
- Includes merge, build, test, CI monitoring
- Makes code changes and commits
- Full end-to-end PR processing
- Multi-step workflow with state management

Use `/review-pr` when you want **review analysis only**.
Use `/pr-process` when you want **full PR processing and merge**.

### Review Report Storage

Failed or manual review reports are saved to:
```
.claude/reviews/pr-{PR_NUMBER}-review.md
```

Consider adding to `.gitignore` if reviews contain sensitive information.

### Integration with Code-Reviewer Agent

This command delegates all analysis to the code-reviewer agent, which:
- Has specialized knowledge of code quality patterns
- Uses quality validation skills
- Provides structured, severity-rated findings
- Follows constructive review philosophy

The command acts as a user-friendly interface to that expertise.

### Automation Tips

For automated review workflows:
```bash
# Review all open PRs
gh pr list --json number --jq '.[].number' | while read pr; do
  /review-pr "$pr" --post-to-pr
  sleep 5  # Rate limit consideration
done
```

For pre-merge validation in CI:
```bash
# In GitHub Actions workflow
- name: Code Review
  run: claude-code "/review-pr ${{ github.event.pull_request.number }}"
```
